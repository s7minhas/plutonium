---
title: "JWacPrez"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

## Basic Paper Outline
-Section 1: Intro  
    -Basic question: Does US distraction due to wars, particularly in the Middle East lead to adverse outcomes in the rest of the world.  
    -Contributions:  
        1. Novel and superior measure of state affinity/preferences/closeness  
        2. Novel measure of US distraction  
        3. Findings about how US distraction leads states to cozy up/distance themselves from China  
    -Can use US withdrawal from Afghanistan and implications for US/China competition as an easy hook  
    -Understand that requires two things, neither of which has really gotten traction in IR (lit reviewy stuff)  
        1. Measure of US distraction  
        2. Measure of state preferences  
-Section 2: Our stylized argument/hypotheses etc. 
    -Two opposing arguments  
        -1) Limited resources/attention, distraction allows for trouble elsewhere  
        -2) Credibility/resolve -- US doing costly things in Middle East should cause us to update (positively) that theyre willing to do costly things elsewhere  
-Section 3: Data and Methods  
    -Measuring Distraction  
    -Measuring State preferences  
-Section 4: Downstream stuff  
    -Closeness to China as a DV, main findings support argument 2  
    -Notably heterogeneous effect -- as US becomes more distracted, it seems like most states move away from China, but Chinas neighbors do the opposite  
-Section 5: Highlight cool results  


##Our Major Measures in More Detail
1. Measure of state affinity. 
    -Drawn from latent factor model.  
    -Basic idea of latent factor model is a model that can account for 3 levels of network dependency  
        -1st order deps -- certain actors are more/less popular than others in all their interactions  
        -2nd order deps -- reciprocality is a thing  
       -3rd order deps -- homophily and stochastic equivalence (the two that most network models arent able to get at)  
    -Gets at 3rd order dependencies using "multiplicative effect" that relies on singular value decomposition.  
    -So we run LFM using a set of economic relations as our dependent variable, and extract this multiplicative effect, as our main measure of state affinity.  
    -Higher values of it are associated with states being more likely to engage in these types of economic cooperation, lower values less likely  
    -We then difference it to get the year to year change in state affinity.  
2. Measure of US distraction.  
    -Take data on US military casualties and mideast commitments, and run a PCA  
    -Alternative measure based on foreign troop commitments and US defense spending  

##Model Setup
Unit of observation: country year from 1992-2019  
DV: Change in our affinity measure for the country to China  
Key IV: lagged measure of US distraction  
Controls: Polity, Population, Distance to Beijing, Bailey/Voeten/Strezhnev Ideal Point Distance, GDP  
Random Effects: By region (using UNs 23 regions)  


##Results
Main Models: Models with region random effects
```{r, echo=FALSE, message = FALSE}
library(knitr)
source("/Users/maxgallop/Documents/Github/plutonium/setup.R")


load("/Users/maxgallop/Dropbox/plutonium/results/dstreamModels_region.rda")
ivs = c(
  '(Intercept)',
  'USf1.l1',
  'USf2.l1',
  'polity.l1',
  'GDP.l1', 'pop.l1',
  'beijDist',
  'IdealPointDistance' )

bMats = lapply(
  list(bf1, bf2, bf1HetEff, bf2HetEff),
  function(x){ as.matrix(x) } )
names(bMats) = c('bf1', 'bf2', 'bf1HetEff', 'bf2HetEff')
####

####
#  quick comparison of iv effs
kable(getCoefB(bMats$'bf1', ivs[-3]))

kable(getCoefB(bMats$'bf2', ivs[-2]))

kable(getCoefB(bMats$'bf1HetEff', ivs[-(2:3)]))

kable(getCoefB(bMats$'bf2HetEff', ivs[-(2:3)]))

ivs = c(
  '(Intercept)',
  'USf1.l1',
  'USf2.l1',
  'polity.l1',
  'GDP.l1', 'pop.l1',
  'beijDist',
  'IdealPointDistance' )
####

####
# pull out mats
bMats = lapply(
  list(bf1, bf2, bf1HetEff, bf2HetEff),
  function(x){ as.matrix(x) } )
names(bMats) = c('bf1', 'bf2', 'bf1HetEff', 'bf2HetEff')
####

####
# ran effects
effs = setdiff(colnames(bMats$'bf1HetEff'), ivs[-(2:3)])
f1effs = effs[!grepl('(Intercept)', effs)]
inteffs = effs[grepl('(Intercept)', effs)]
f1HetEffs = getCoefB(bMats$'bf1HetEff', f1effs, T)
int1HetEffs = getCoefB(bMats$'bf1HetEff', inteffs, T)

effs = setdiff(colnames(bMats$'bf2HetEff'), ivs[-(2:3)])
f2effs = effs[!grepl('(Intercept)', effs)]
inteffs = effs[grepl('(Intercept)', effs)]
f2HetEffs = getCoefB(bMats$'bf2HetEff', f2effs, T)
int2HetEffs = getCoefB(bMats$'bf2HetEff', inteffs, T)
plot(bf1HetEff, pars = f1effs)
plot(bf2HetEff, pars = f2effs)
```

Main Models: Models with Country random effects
```{r, echo=FALSE, message = FALSE, warning = FALSE}

load("/Users/maxgallop/Dropbox/plutonium/results/dstreamModels_cname.rda")
pkgs = c(
  'lme4', 'rstanarm', 'ggplot2', 'maps', 'patchwork' , 'mapproj')
loadPkg(pkgs)

ivs = c(
  '(Intercept)',
  'USf1.l1',
  'USf2.l1',
  'polity.l1',
  'GDP.l1', 'pop.l1',
  'beijDist',
  'IdealPointDistance' )

bMats = lapply(
  list(bf1, bf2, bf1HetEff, bf2HetEff),
  function(x){ as.matrix(x) } )
names(bMats) = c('bf1', 'bf2', 'bf1HetEff', 'bf2HetEff')
####

####
#  quick comparison of iv effs
kable(getCoefB(bMats$'bf1', ivs[-3]))

kable(getCoefB(bMats$'bf2', ivs[-2]))

kable(getCoefB(bMats$'bf1HetEff', ivs[-(2:3)]))

kable(getCoefB(bMats$'bf2HetEff', ivs[-(2:3)]))

ivs = c(
  '(Intercept)',
  'USf1.l1',
  'USf2.l1',
  'polity.l1',
  'GDP.l1', 'pop.l1',
  'beijDist',
  'IdealPointDistance' )
####

####
# pull out mats
bMats = lapply(
  list(bf1, bf2, bf1HetEff, bf2HetEff),
  function(x){ as.matrix(x) } )
names(bMats) = c('bf1', 'bf2', 'bf1HetEff', 'bf2HetEff')
####

####
# ran effects
effs = setdiff(colnames(bMats$'bf1HetEff'), ivs[-(2:3)])
f1effs = effs[!grepl('(Intercept)', effs)]
inteffs = effs[grepl('(Intercept)', effs)]
f1HetEffs = getCoefB(bMats$'bf1HetEff', f1effs, T)
int1HetEffs = getCoefB(bMats$'bf1HetEff', inteffs, T)

write.csv(f1HetEffs, file='/Users/maxgallop/Desktop/tmp.csv')

effs = setdiff(colnames(bMats$'bf2HetEff'), ivs[-(2:3)])
f2effs = effs[!grepl('(Intercept)', effs)]
inteffs = effs[grepl('(Intercept)', effs)]
f2HetEffs = getCoefB(bMats$'bf2HetEff', f2effs, T)
int2HetEffs = getCoefB(bMats$'bf2HetEff', inteffs, T)
####

####
# ran eff map

# org heter eff data
hetEffs = list(f1HetEffs, f2HetEffs)
hetEffs = lapply(1:length(hetEffs), function(ii){
  x = hetEffs[[ii]]
  df = data.frame(x, row.names=NULL)
  cntry = rownames(x)
  cntry = gsub(paste0('b[USf',ii,'.l1 cname1:'),'',cntry,fixed=TRUE)
  cntry = gsub(']', '', cntry, fixed=TRUE)
  cntry = trim(cntry)
  cntry = countrycode(cntry, 'country.name', 'country.name')
  df = cbind(cntry=cntry, df)
  df$sig = ((df$qtLo95*df$qtHi95)>0)*sign(df$mu)
  return(df) })
names(hetEffs) = c('f1', 'f2')

# org heter eff data
intEffs = list(int1HetEffs, int2HetEffs)
intEffs = lapply(1:length(intEffs), function(ii){
  x = intEffs[[ii]]
  df = data.frame(x, row.names=NULL)
  cntry = rownames(x)
  cntry = gsub('b[(Intercept) cname1:','',cntry,fixed=TRUE)
  cntry = gsub(']', '', cntry, fixed=TRUE)
  cntry = trim(cntry)
  cntry = countrycode(cntry, 'country.name', 'country.name')
  df = cbind(cntry=cntry, df)
  df$sig = ((df$qtLo95*df$qtHi95)>0)*sign(df$mu)
  return(df) })
names(intEffs) = c('i1', 'i2')

# bring in map data
world = map_data("world")
world$cname = countrycode(world$region, 'country.name', 'country.name')
world = world[!is.na(world$cname),]
world = world[world$cname!='Greenland',]

# merge in hetEff data
toMerge = names(hetEffs[[1]])[-1]
mods = names(hetEffs)
for(mod in mods){
  slice = hetEffs[[mod]]
  for(v in toMerge){
    world$tmp = slice[match(world$cname, slice$cntry),v]
    names(world)[ncol(world)] = paste0(mod,'_',v) } }

# merge in intEff data
toMerge = names(intEffs[[1]])[-1]
mods = names(intEffs)
for(mod in mods){
  slice = intEffs[[mod]]
  for(v in toMerge){
    world$tmp = slice[match(world$cname, slice$cntry),v]
    names(world)[ncol(world)] = paste0(mod,'_',v) } }

# maps
makeMap = function(dat, var, cat=FALSE, legWidth=1){

  # desig colVar
  dat$colVar = dat[,var]

  # set up gg frame
  gg = ggplot(dat, aes(x=long, y=lat, group=group))

  # desig what should happen if cat or not
  if(!cat){
    gg = gg +
      geom_polygon(
        aes(group=group, fill=colVar),
        color='grey20', size=.1 ) +
      scale_fill_gradient2() }
  if(cat){
    gg = gg +
      geom_polygon(
        aes(group=group, fill=factor(colVar)),
        color='grey20', size=.1 ) +
      scale_fill_manual(values=c('#e41a1c', '#f0f0f0', '#377eb8')) }

  # cleanup plot
  gg = gg +
    coord_map(xlim=c(-180,180), ylim=c(-50,80)) +
    theme_void() +
    theme(
      legend.position='top',
      legend.key.width=unit(legWidth,'cm') )

  #
  return(gg) }

# apply fns
f1map = makeMap(world, 'f1_mu', F, 1)
f2map = makeMap(world, 'f2_mu', F, 1)
f1sigmap = makeMap(world, 'f1_sig', T, .5)
f2sigmap = makeMap(world, 'f2_sig', T, .5)

# apply fns
i1map = makeMap(world, 'i1_mu', F, 1)
i2map = makeMap(world, 'i2_mu', F, 1)
i1sigmap = makeMap(world, 'i1_sig', T, .5)
i2sigmap = makeMap(world, 'i2_sig', T, .5)

#
maps = (f1map + f2map) / (f1sigmap + f2sigmap)
plot(maps)

```

Lasso using all 3 measures of US distraction and region fixed effects.
```{r, echo=FALSE, message = FALSE}
load("/Users/maxgallop/Dropbox/plutonium/data/forMD.rda")
library(glmnet)
library(plotmo)

lasso2 = glmnet(lassoData[,c(1:8)], y = lassoData$econDelta, alpha = 1)
plot_glmnet(lasso2, xvar="dev", label = 20, lwd=2, cex=2)

lasso3 = glmnet(lassoData[,c(1:8, 10:28)], y = lassoData$econDelta, alpha = 1)
plot_glmnet(lasso3, xvar="dev", label = T, lwd=2, cex=2)

```


## Heterogeneous Effects
## Takeaways
1. Globally does not seem like US distraction leads states closer to China, in most cases, they move farther away.  
2. This seems less true for China's close neighbors.  
3. Measures of US distraction seem to explain a great deal of the variance in the affinity data  
4. Most control variables behave as we'd expect them to -- more democratic/rich states are more likely to move away from China, more populous / close to China states move towards the PRC, Bailey/Voeten/Strezhnev's Ideal point measure is being weird though -- states that are further from China are more likely to move towards them  

## Next Steps
1. Get data on natural resource endowments
2. Rerun models seeing if US distraction metrics are conditioned by
    1. Natural resource endowment
    2. Regime type (polity autoc/anoc/democ)
    3. Strategic concerns (geography I guess)
